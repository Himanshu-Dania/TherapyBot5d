<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Therapy Chatbot</title>
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-gray-100 min-h-screen">
        <div class="container mx-auto p-4 max-w-2xl">
            <div class="bg-white rounded-lg shadow-lg p-4">
                <div
                    id="chat-container"
                    class="h-[500px] overflow-y-auto mb-4 space-y-4"
                >
                    <!-- Messages will be inserted here -->
                </div>

                <form id="chat-form" class="flex gap-2">
                    <input
                        type="text"
                        id="message-input"
                        class="flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Type your message..."
                    />
                    <button
                        type="submit"
                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-400"
                    >
                        Send
                    </button>
                </form>
            </div>
        </div>

        <script>
            // Generate a random session ID
            const sessionId = crypto.randomUUID();
            const messageInput = document.getElementById("message-input");
            const chatForm = document.getElementById("chat-form");
            const chatContainer = document.getElementById("chat-container");
            let isLoading = false;

            function appendMessage(content, isUser) {
                const messageDiv = document.createElement("div");
                messageDiv.className = `p-4 rounded-lg ${
                    isUser ? "bg-blue-100 ml-auto" : "bg-gray-100 mr-auto"
                } max-w-[80%]`;
                messageDiv.textContent = content;
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            async function handleSubmit(e) {
                e.preventDefault();
                if (isLoading || !messageInput.value.trim()) return;

                const message = messageInput.value.trim();
                messageInput.value = "";
                isLoading = true;

                // Add user message
                appendMessage(message, true);

                try {
                    const response = await fetch("/chat", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            message,
                            sessionId,
                            userId: "user-1",
                        }),
                    });

                    if (!response.ok)
                        throw new Error("Network response was not ok");

                    // Create the message div once at the start
                    const messageDiv = document.createElement("div");
                    messageDiv.className = `p-4 rounded-lg bg-gray-100 mr-auto max-w-[80%]`;
                    chatContainer.appendChild(messageDiv);

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    let currentMessage = "";
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split("\n");

                        for (const line of lines) {
                            if (line.startsWith("data: ")) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    if (data.content) {
                                        currentMessage += data.content;
                                        messageDiv.textContent = currentMessage;
                                        // Force scroll to bottom
                                        chatContainer.scrollTop =
                                            chatContainer.scrollHeight;
                                    }
                                } catch (e) {
                                    console.error("Error parsing SSE data:", e);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error("Error:", error);
                    appendMessage(
                        "An error occurred while sending your message.",
                        false
                    );
                } finally {
                    isLoading = false;
                }
            }

            chatForm.addEventListener("submit", handleSubmit);
        </script>
    </body>
</html>
